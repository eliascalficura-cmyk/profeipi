<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <title>PROFE IPI | IPINCE 2026</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;700;900&family=JetBrains+Mono:wght@400;700&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --bg-main: #020305;
            --text-main: #ffffff;
            --accent-color: #4F46E5;
            --glass-color: rgba(255, 255, 255, 0.03);
            --glass-blur: 40px;
            --border-color: rgba(255, 255, 255, 0.1);
            --spark-color: #00f2ff;
            --spark-glow: rgba(0, 242, 255, 0.4);
        }

        body {
            background: var(--bg-main);
            color: #fff;
            font-family: 'Inter', -apple-system, system-ui, sans-serif;
            overflow: hidden;
            height: 100vh;
            margin: 0;
            transition: background 0.8s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .glass {
            background: var(--glass-color);
            backdrop-filter: blur(var(--glass-blur)) saturate(180%);
            -webkit-backdrop-filter: blur(var(--glass-blur)) saturate(180%);
            border: 1px solid var(--border-color);
            border-radius: 1.25rem;
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .mono {
            font-family: 'JetBrains Mono', monospace;
        }

        /* CENTRAL SUBTITLES - CRITICAL VISIBILITY */
        #subtitles {
            font-size: 1.8rem !important;
            font-weight: 800 !important;
            color: #ffffff !important;
            line-height: 1.4;
            padding: 2.5rem 4rem;
            background: rgba(0, 0, 0, 0.85) !important;
            /* Fondo muy oscuro para contraste */
            backdrop-filter: blur(20px);
            border-radius: 1.5rem;
            border: 2px solid var(--accent-color);
            min-height: 100px;
            max-width: 80%;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            box-shadow: 0 30px 100px rgba(0, 0, 0, 1);
            z-index: 9999 !important;
            /* Capa superior absoluta */
            position: relative;
            text-shadow: 2px 2px 10px rgba(0, 0, 0, 1);
        }

        .chat-text {
            color: #ffffff !important;
        }

        .hud-tag {
            padding: 0.3rem 0.8rem;
            border-radius: 99px;
            font-size: 10px;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            background: rgba(79, 70, 229, 0.2);
            border: 1px solid var(--accent-color);
            color: #fff;
            box-shadow: 0 0 15px rgba(79, 70, 229, 0.3);
        }

        .alabaster-theme {
            background: #F8FAFC !important;
            color: #0F172A !important;
            --accent-color: #4F46E5;
            --glass-color: rgba(255, 255, 255, 0.8);
            --border-color: rgba(0, 0, 0, 0.05);
        }

        .onyx-theme {
            background: #020305 !important;
            color: #ffffff !important;
            --accent-color: #818CF8;
            --glass-color: rgba(255, 255, 255, 0.03);
            --border-color: rgba(255, 255, 255, 0.1);
        }
    </style>
</head>

<body class="onyx-theme">
    <div class="relative z-10 h-screen w-screen p-10 flex flex-col gap-8">

        <!-- TOP HUD -->
        <header class="w-full flex justify-between items-start pointer-events-auto">
            <div class="flex flex-col gap-2">
                <div class="flex items-center gap-5">
                    <h1 class="font-black text-4xl tracking-tight uppercase italic">Prof. <span
                            style="color: var(--accent-color)">Ipince</span></h1>
                    <span class="hud-tag" id="status-tag">Sistema_Listo</span>
                </div>
                <div class="mono text-[9px] opacity-40 uppercase tracking-[0.5em]">ATMCHILE // OPTIMIZACI√ìN_360 //
                    <span class="text-indigo-400 font-bold">NEXUS_CORE</span>
                </div>
            </div>

            <div class="flex gap-4">
                <div class="glass px-6 py-3 flex flex-col items-end">
                    <span class="mono text-[8px] opacity-40 uppercase">Sync_Latency</span>
                    <span id="perf-lat" class="text-sm font-bold text-indigo-400">0ms</span>
                </div>
                <div class="glass px-6 py-3 flex flex-col items-end">
                    <span class="mono text-[8px] opacity-40 uppercase">Audio_Conf</span>
                    <span id="conf-val" class="text-sm font-bold text-indigo-400">0%</span>
                </div>
                <div class="glass px-6 py-3 flex flex-col items-end min-w-[140px]">
                    <span class="mono text-[8px] opacity-40 uppercase">Activaci√≥n</span>
                    <span id="activation-status" class="text-sm font-bold text-gray-500">üîá Inactivo</span>
                </div>
                <button id="classroom-btn"
                    class="glass px-8 py-4 text-[10px] font-bold uppercase tracking-widest hover:bg-white/5 transition-all text-amber-500 border-amber-500/30">
                    Modo: Estrategia
                </button>
                <button id="fast-mode-btn"
                    class="glass px-8 py-4 text-[10px] font-bold uppercase tracking-widest hover:bg-white/5 transition-all text-green-500 border-green-500/30">
                    ‚ö° Modo Texto
                </button>
                <button id="mode-btn"
                    class="glass px-8 py-4 text-[10px] font-bold uppercase tracking-widest hover:bg-white/5 transition-all">
                    Cambiar_Tema
                </button>
            </div>
        </header>

        <!-- CENTER INTERFACE -->
        <main class="flex-1 flex gap-8 min-h-0">
            <div class="flex-1 glass relative overflow-hidden flex flex-col items-center justify-center">
                <div id="canvas-stage" style="width: 100%; height: 100%;"></div>

                <!-- SUBTITLES (IPINCE CATEDRA) -->
                <div class="absolute bottom-24 w-full flex justify-center px-10 pointer-events-none z-[9999]">
                    <div id="subtitles" class="opacity-0 chat-text">// SISTEMA DE ESCUCHA ACTIVO //</div>
                </div>

                <!-- SIGNAL METERS -->
                <div class="absolute left-10 top-1/2 -translate-y-1/2 flex flex-col gap-10 opacity-30">
                    <div class="flex flex-col gap-2 items-center">
                        <span class="mono text-[8px] uppercase -rotate-90 origin-center mb-10">Vocal_Spectrum</span>
                        <div class="w-1 h-40 bg-white/5 rounded-full overflow-hidden">
                            <div id="gate-lvl" class="w-full bg-indigo-500 transition-all duration-150"
                                style="height: 0%"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- TACTICAL ASIDE -->
            <aside class="w-[450px] flex flex-col gap-8 min-h-0 pointer-events-auto">
                <div class="flex-1 glass p-10 flex flex-col min-h-0">
                    <div class="flex justify-between items-center mb-8 border-b border-white/5 pb-5">
                        <span
                            class="mono text-[10px] font-bold text-indigo-400 uppercase tracking-widest">Neural_Bridge_Log</span>
                        <div class="w-2.5 h-2.5 rounded-full bg-indigo-500 animate-pulse"></div>
                    </div>

                    <div id="logs"
                        class="flex-1 overflow-y-auto space-y-5 pr-4 mono text-[12px] opacity-50 scrollbar-hide">
                        <div>// Ipince 2026 Core established.</div>
                        <div>// Purging legacy protocols...</div>
                    </div>

                    <div class="mt-8 pt-5 border-t border-white/5">
                        <input type="text" id="manual-input" placeholder="Comando prioritario..."
                            class="w-full bg-transparent border-b border-white/10 px-0 py-4 text-sm focus:outline-none focus:border-indigo-400 transition-all font-light">
                    </div>
                </div>

                <!-- VISION BRIDGE -->
                <div class="h-52 glass relative overflow-hidden">
                    <video id="v-feed" class="w-full h-full object-cover filter brightness-75 contrast-125" autoplay
                        playsinline muted></video>
                    <div class="absolute top-4 left-4 mono text-[8px] bg-black/60 px-3 py-1.5 rounded-sm uppercase">
                        Optic_Sync_Active</div>
                </div>

                <!-- CONTROLS -->
                <div class="grid grid-cols-2 gap-5">
                    <button id="engage-btn"
                        class="glass py-6 font-bold uppercase tracking-widest text-[11px] hover:bg-white/5 transition-all text-indigo-400">Iniciar_Cortex</button>
                    <button id="stop-btn" disabled
                        class="glass py-6 font-bold uppercase tracking-widest text-[11px] opacity-20">En_Espera</button>
                </div>
            </aside>
        </main>

        <footer class="w-full flex justify-between items-end opacity-30">
            <div class="mono text-[9px] uppercase tracking-[0.5em]">atmchile // ipince_master_node // 2026_release</div>
            <div class="mono text-[9px] uppercase tracking-[0.5em]">premium_glass_interface</div>
        </footer>
    </div>

    <!-- ENGINE CORE -->
    <script type="module">
        import * as THREE from 'https://cdn.skypack.dev/three@0.136.0';

        const logs = document.getElementById('logs');
        function addLog(msg, type = "SYSTEM") {
            if (!logs) return;
            const div = document.createElement('div');
            if (type === "USER") div.className = "text-indigo-400 font-bold border-l-2 pl-4 border-indigo-400 py-1";
            else if (type === "IPI") div.className = "text-white opacity-90 border-r-2 pr-4 text-right border-white/20 italic py-1";
            else div.className = "opacity-30 py-1";
            div.innerText = type === "SYSTEM" ? `// ${msg}` : msg;
            logs.appendChild(div);
            logs.scrollTop = logs.scrollHeight;
        }

        const stage = document.getElementById('canvas-stage');
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(45, stage.clientWidth / stage.clientHeight || 1, 0.1, 1000);
        camera.position.z = 50;

        const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        const updateRendererSize = () => {
            const w = stage.clientWidth || window.innerWidth * 0.6;
            const h = stage.clientHeight || window.innerHeight * 0.6;
            renderer.setSize(w, h);
            camera.aspect = w / h;
            camera.updateProjectionMatrix();
        };
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
        stage.appendChild(renderer.domElement);
        updateRendererSize();

        const sparkGeo = new THREE.IcosahedronBufferGeometry(15, 64);
        const sparkMat = new THREE.ShaderMaterial({
            uniforms: {
                uTime: { value: 0 },
                uVoice: { value: 0 },
                uPulse: { value: 0 },
                uColor: { value: new THREE.Color(0x4F46E5) }
            },
            vertexShader: `
                uniform float uTime;
                uniform float uVoice;
                uniform float uPulse;
                varying float vDist;
                void main() {
                    vec3 pos = position;
                    float dist = sin(pos.x * 2.0 + uTime) * cos(pos.y * 2.0 + uTime) * (uVoice * 10.0 + 0.5 + uPulse * 5.0);
                    vDist = dist;
                    pos += normal * dist;
                    gl_Position = projectionMatrix * modelViewMatrix * vec4(pos, 1.0);
                }
            `,
            fragmentShader: `
                uniform vec3 uColor;
                uniform float uPulse;
                varying float vDist;
                void main() {
                    vec3 col = uColor + (vDist * 0.1) + (uPulse * 0.5);
                    gl_FragColor = vec4(col, 0.8 - (vDist * 0.2));
                }
            `,
            wireframe: true, transparent: true
        });
        const spark = new THREE.Mesh(sparkGeo, sparkMat);
        scene.add(spark);

        let active = false, isSpeaking = false, isLightMode = false, audioCtx, analyzer, dataArray, rec, currentAudio = null, mode = 'STRATEGY';
        const engageBtn = document.getElementById('engage-btn');
        const stopBtn = document.getElementById('stop-btn');
        const subEl = document.getElementById('subtitles');
        const statusTag = document.getElementById('status-tag');
        const manualInput = document.getElementById('manual-input');

        // Chistes del Profe IPI para cuando hay problemas de conexi√≥n
        const connectionJokes = [
            "Esperando conexi√≥n... ¬øSab√≠as que el internet es como la log√≠stica? Cuando funciona bien, nadie lo nota. Cuando falla, todos se quejan. üòÑ",
            "Parece que el internet est√° haciendo una pausa estrat√©gica... Como dir√≠a en clase: 'La paciencia es la log√≠stica del tiempo'. üöÄ",
            "Conexi√≥n lenta detectada... Esto me recuerda a mis alumnos cuando les pregunto por la tarea: 'Profe, se me cay√≥ el internet'. ¬°Ahora entiendo! üòÖ",
            "Buscando se√±al... En log√≠stica esto se llama 'tiempo de espera'. En internet, se llama 'frustraci√≥n'. Pero tranquilo, ya vuelvo. ‚è≥",
            "Internet inestable... Como le digo a mis estudiantes: 'No es el sistema el que falla, es la infraestructura'. Esperemos que vuelva pronto. üåê",
            "Reconectando... ¬øSab√≠as que en log√≠stica el 80% del tiempo es espera? Parece que el internet tambi√©n estudi√≥ mi curso. üìö",
            "Se√±al d√©bil... Esto es como cuando explico cadena de suministro y alguien pregunta '¬øpara qu√© sirve?'. ¬°Ahora lo ves! Sin conexi√≥n, nada funciona. üí°"
        ];

        let connectionRetries = 0;
        const MAX_RETRIES = 3;

        async function processAI(text, isRetry = false) {
            if (!text || isSpeaking) return;
            if (currentAudio) { currentAudio.pause(); currentAudio = null; }

            isSpeaking = true;
            statusTag.innerText = "PROCESANDO_NEXUS";
            subEl.innerHTML = "";
            subEl.style.opacity = "1";

            if (!isRetry) {
                addLog(text, "USER");
                connectionRetries = 0;
            }

            let imageB64 = null;
            try {
                const video = document.getElementById('v-feed');
                if (video && video.readyState === 4) {
                    const canvas = document.createElement('canvas');
                    canvas.width = 480; canvas.height = 360;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                    imageB64 = canvas.toDataURL('image/jpeg', 0.6);
                }
            } catch (e) { }

            try {
                const t0 = performance.now();

                // Crear un timeout para detectar problemas de conexi√≥n
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), CONNECTION_TIMEOUT_MS); // Timeout optimizado

                statusTag.innerText = "CONECTANDO...";

                const res = await fetch(`/api/chat`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        prompt: `[MODE: ${mode}] ` + text,
                        image_b64: imageB64,
                        session_id: "session_ipi_premium"
                    }),
                    signal: controller.signal
                });

                clearTimeout(timeoutId);

                if (!res.ok) {
                    throw new Error(`Error del servidor: ${res.status}`);
                }

                const data = await res.json();
                document.getElementById('perf-lat').innerText = `${(performance.now() - t0).toFixed(0)}ms`;

                // Resetear contador de reintentos si fue exitoso
                connectionRetries = 0;
                statusTag.innerText = "NEXUS_ACTIVO";

                if (data.response) {
                    addLog(data.response, "IPI");
                    elegantType(subEl, data.response);

                    if (data.audio && !fastMode) {
                        const audio = new Audio("data:audio/mp3;base64," + data.audio);
                        currentAudio = audio;
                        audio.onended = () => {
                            isSpeaking = false;
                            setTimeout(() => { if (!isSpeaking) subEl.style.opacity = "0"; }, 4000);
                            statusTag.innerText = "SISTEMA_ESCUCHANDO";
                            if (active && rec) try { rec.start(); } catch (e) { }
                        };
                        audio.play();
                    } else {
                        isSpeaking = false;
                        if (active && rec) try { rec.start(); } catch (e) { }
                    }
                } else {
                    addLog("ERROR: No Nexus Response", "SYSTEM");
                    isSpeaking = false;
                    if (active && rec) try { rec.start(); } catch (e) { }
                }
            } catch (err) {
                const isNetworkError = err.name === 'AbortError' || err.message.includes('fetch') || err.message.includes('network');

                if (isNetworkError) {
                    connectionRetries++;

                    // Mostrar chiste aleatorio
                    const randomJoke = connectionJokes[Math.floor(Math.random() * connectionJokes.length)];
                    elegantType(subEl, randomJoke);
                    statusTag.innerText = `SIN_CONEXI√ìN (${connectionRetries}/${MAX_RETRIES})`;
                    addLog(`Problema de conexi√≥n detectado. Intento ${connectionRetries}/${MAX_RETRIES}`, "SYSTEM");

                    // Reintentar si no hemos alcanzado el m√°ximo
                    if (connectionRetries < MAX_RETRIES) {
                        addLog(`Reintentando en 3 segundos...`, "SYSTEM");
                        setTimeout(() => {
                            processAI(text, true);
                        }, 3000);
                    } else {
                        addLog("M√°ximo de reintentos alcanzado. Verifica tu conexi√≥n a internet.", "SYSTEM");
                        elegantType(subEl, "üîå No logro conectarme. Verifica tu internet y vuelve a intentarlo. Mientras tanto, aqu√≠ estar√©... pensando en log√≠stica. ü§î");
                        statusTag.innerText = "CONEXI√ìN_PERDIDA";
                        isSpeaking = false;
                        if (active && rec) try { rec.start(); } catch (e) { }
                    }
                } else {
                    // Error que no es de red
                    addLog(`ERROR: ${err.message}`, "SYSTEM");
                    elegantType(subEl, "Ups, algo sali√≥ mal en mi procesamiento. ¬øPuedes repetir la pregunta? ü§î");
                    statusTag.innerText = "ERROR_INTERNO";
                    isSpeaking = false;
                    if (active && rec) try { rec.start(); } catch (e) { }
                }
            }
        }

        function elegantType(element, message) {
            if (!message) return;
            element.textContent = "";
            let i = 0;
            if (element.typingInterval) clearInterval(element.typingInterval);
            element.style.opacity = "1";
            element.typingInterval = setInterval(() => {
                if (i < message.length) {
                    element.textContent += message.charAt(i);
                    i++;
                } else {
                    clearInterval(element.typingInterval);
                }
            }, 25);
        }

        engageBtn.onclick = async () => {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true, video: true });
                document.getElementById('v-feed').srcObject = stream;
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                const source = audioCtx.createMediaStreamSource(stream);
                analyzer = audioCtx.createAnalyser();
                source.connect(analyzer);
                dataArray = new Uint8Array(analyzer.frequencyBinCount);
                active = true;
                engageBtn.disabled = true; stopBtn.disabled = false;
                engageBtn.classList.add('opacity-10'); stopBtn.classList.remove('opacity-20');
                statusTag.innerText = "ESCRIBIR_O_HABLAR";
                startRecognition();
            } catch (e) { addLog("MICROFONO_DENEGADO", "SYSTEM"); }
        };

        stopBtn.onclick = () => {
            active = false;
            engageBtn.disabled = false; stopBtn.disabled = true;
            engageBtn.classList.remove('opacity-10'); stopBtn.classList.add('opacity-20');
            statusTag.innerText = "SISTEMA_LISTO";
            if (rec) try { rec.stop(); } catch (e) { }
            if (currentAudio) currentAudio.pause();
        };

        manualInput.onkeypress = (e) => { if (e.key === 'Enter') { processAI(manualInput.value); manualInput.value = ""; } };

        // Palabras clave de activaci√≥n
        const ACTIVATION_KEYWORDS = ['profe', 'profesor', 'oye profe', 'hola profe', 'profesor ipince', 'ipince'];

        // CONSTANTES DE OPTIMIZACI√ìN
        const ACTIVATION_TIMEOUT_MS = 7000;  // Tiempo para completar comando despu√©s de activaci√≥n
        const SILENCE_TIMEOUT_MS = 800;      // Tiempo de silencio antes de procesar
        const CONNECTION_TIMEOUT_MS = 10000; // Timeout de conexi√≥n al servidor
        const MIN_TRANSCRIPT_LENGTH = 5;     // M√≠nimo de caracteres para procesar

        let isListeningForCommand = false;
        let lastProcessedText = '';
        let activationTimeout = null;
        let fastMode = false; // Modo r√°pido sin audio

        function containsActivationKeyword(text) {
            const lowerText = text.toLowerCase();
            return ACTIVATION_KEYWORDS.some(keyword => lowerText.includes(keyword));
        }

        function startRecognition() {
            const SpeechRec = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SpeechRec) {
                addLog("Reconocimiento de voz no disponible en este navegador", "SYSTEM");
                return;
            }

            rec = new SpeechRec();
            rec.lang = 'es-CL';
            rec.continuous = true;
            rec.interimResults = true;
            rec.maxAlternatives = 3; // Mejora precisi√≥n evaluando m√∫ltiples alternativas

            let silenceTimer = null;
            let currentTranscript = '';

            rec.onresult = (e) => {
                if (isSpeaking) return;

                const results = e.results[e.results.length - 1];
                const transcript = results[0].transcript.trim();
                const confidence = results[0].confidence;
                const isFinal = results.isFinal;

                document.getElementById('conf-val').innerText = `${(confidence * 100).toFixed(0)}%`;

                // Actualizar transcript actual
                currentTranscript = transcript;

                // Verificar si contiene palabra de activaci√≥n
                if (containsActivationKeyword(transcript)) {
                    isListeningForCommand = true;
                    statusTag.innerText = "ESCUCHANDO_COMANDO";
                    document.getElementById('activation-status').innerHTML = "üé§ <span class='text-green-400'>Activo</span>";
                    sparkMat.uniforms.uPulse.value = 1.0;

                    // Limpiar timeout de activaci√≥n anterior
                    clearTimeout(activationTimeout);

                    // Dar 5 segundos para completar el comando despu√©s de la activaci√≥n
                    activationTimeout = setTimeout(() => {
                        isListeningForCommand = false;
                        statusTag.innerText = "SISTEMA_ESCUCHANDO";
                        document.getElementById('activation-status').innerHTML = "‚è∏Ô∏è <span class='text-yellow-400'>Esperando</span>";
                        addLog("Tiempo de comando expirado. Di 'Profe' para activar nuevamente.", "SYSTEM");
                    }, ACTIVATION_TIMEOUT_MS);
                }

                // Mostrar preview de lo que est√° escuchando
                const previewEl = document.getElementById('subtitles');
                if (isListeningForCommand && !isFinal && transcript.length > MIN_TRANSCRIPT_LENGTH) {
                    previewEl.textContent = `üé§ ${transcript}...`;
                    previewEl.style.opacity = '0.5';
                }

                // Solo procesar si est√° en modo comando y es resultado final
                if (isListeningForCommand && isFinal && transcript.length > MIN_TRANSCRIPT_LENGTH) {
                    // Evitar procesar el mismo texto dos veces
                    if (transcript === lastProcessedText) {
                        return;
                    }

                    // Evitar que procese su propia respuesta
                    const containsOwnResponse = transcript.includes('dato') && transcript.includes('an√°lisis') && transcript.includes('recomendaci√≥n');
                    if (containsOwnResponse) {
                        addLog("Eco detectado - ignorando", "SYSTEM");
                        return;
                    }

                    sparkMat.uniforms.uPulse.value = 0.5;
                    clearTimeout(silenceTimer);
                    clearTimeout(activationTimeout);

                    // Esperar tiempo optimizado de silencio antes de procesar
                    silenceTimer = setTimeout(() => {
                        lastProcessedText = currentTranscript;
                        isListeningForCommand = false;
                        processAI(currentTranscript);
                        currentTranscript = '';
                    }, SILENCE_TIMEOUT_MS);
                } else if (!isListeningForCommand && transcript.length > 5) {
                    // Mostrar hint visual de que necesita activaci√≥n
                    sparkMat.uniforms.uPulse.value = 0.1;
                }
            };

            rec.onerror = (e) => {
                if (e.error === 'no-speech') {
                    // Ignorar error de no-speech, es normal
                    return;
                }
                addLog(`Error de reconocimiento: ${e.error}`, "SYSTEM");
            };

            rec.onend = () => {
                if (active && !isSpeaking) {
                    try {
                        rec.start();
                    } catch (e) {
                        addLog("Error al reiniciar reconocimiento", "SYSTEM");
                    }
                }
            };

            try {
                rec.start();
                document.getElementById('activation-status').innerHTML = "‚è∏Ô∏è <span class='text-yellow-400'>Esperando</span>";
                addLog("Sistema de voz activado. Di 'Profe' o 'Profesor' para comenzar.", "SYSTEM");
            } catch (e) {
                addLog("Error al iniciar reconocimiento de voz", "SYSTEM");
            }
        }

        function animate() {
            requestAnimationFrame(animate);
            sparkMat.uniforms.uTime.value += 0.04;
            if (active && analyzer) {
                analyzer.getByteFrequencyData(dataArray);
                const avg = dataArray.reduce((p, c) => p + c, 0) / dataArray.length;
                document.getElementById('gate-lvl').style.height = (avg * 1.5) + '%';
                const intens = Math.min(avg / 100, 1.0);
                sparkMat.uniforms.uVoice.value += (intens - sparkMat.uniforms.uVoice.value) * 0.15;
                spark.rotation.y += 0.01 + intens * 0.1;
            }
            renderer.render(scene, camera);
        }
        animate();

        const toggleTheme = (light) => {
            isLightMode = light;
            const b = document.body;
            if (light) {
                b.classList.remove('onyx-theme'); b.classList.add('alabaster-theme');
                sparkMat.uniforms.uColor.value.set(0x4F46E5);
            } else {
                b.classList.remove('alabaster-theme'); b.classList.add('onyx-theme');
                sparkMat.uniforms.uColor.value.set(0x818CF8);
            }
        };

        document.getElementById('mode-btn').onclick = () => toggleTheme(!isLightMode);

        // Toggle Fast Mode (Sin audio para respuestas m√°s r√°pidas)
        const fastModeBtn = document.getElementById('fast-mode-btn');
        fastModeBtn.onclick = () => {
            fastMode = !fastMode;
            if (fastMode) {
                fastModeBtn.innerHTML = '‚ö° <span class="text-green-400">Modo R√°pido ON</span>';
                fastModeBtn.classList.add('bg-green-500/20');
                addLog("Modo r√°pido activado: Solo texto, sin audio (3x m√°s r√°pido)", "SYSTEM");
            } else {
                fastModeBtn.innerHTML = '‚ö° Modo Texto';
                fastModeBtn.classList.remove('bg-green-500/20');
                addLog("Modo normal: Audio + Texto", "SYSTEM");
            }
        };

        const classroomBtn = document.getElementById('classroom-btn');
        classroomBtn.onclick = () => {
            if (mode === 'STRATEGY') {
                mode = 'CLASSROOM';
                classroomBtn.innerText = 'Modo: Aula (LogiMaster)';
                classroomBtn.classList.replace('text-amber-500', 'text-green-500');
            } else {
                mode = 'STRATEGY';
                classroomBtn.innerText = 'Modo: Estrategia';
                classroomBtn.classList.replace('text-green-500', 'text-amber-500');
            }
        };

        window.addEventListener('resize', updateRendererSize);
    </script>
</body>

</html>